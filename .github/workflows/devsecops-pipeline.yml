name: DevSecOps Security Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - '2-DevSecOps-Example/**'
      - '.github/workflows/devsecops-pipeline.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '2-DevSecOps-Example/**'

jobs:
  lint:
    name:  Linting + Security Rules
    runs-on: ubuntu-latest
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '2-DevSecOps-Example/package-lock.json'

      - name: Instalar dependencias
        working-directory: 2-DevSecOps-Example
        run: npm ci

      - name: Ejecutar ESLint
        working-directory: 2-DevSecOps-Example
        run: npm run lint

  test:
    name:  Security Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '2-DevSecOps-Example/package-lock.json'

      - name: Instalar dependencias
        working-directory: 2-DevSecOps-Example
        run: npm ci

      - name: Ejecutar tests de seguridad
        working-directory: 2-DevSecOps-Example
        run: npm test

      - name: Upload cobertura
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-devsecops
          path: 2-DevSecOps-Example/coverage/

  dependency-scan:
    name:  Dependency Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '2-DevSecOps-Example/package-lock.json'

      - name: Instalar dependencias
        working-directory: 2-DevSecOps-Example
        run: npm ci

      - name: NPM Audit
        working-directory: 2-DevSecOps-Example
        run: npm audit --audit-level=moderate
        continue-on-error: true

  build:
    name:  Build Secure Docker
    runs-on: ubuntu-latest
    needs: [test, dependency-scan]
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./2-DevSecOps-Example
          push: false
          tags: devsecops-demo:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name:  Secure Deploy
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy Simulation
        run: |
          echo " Desplegando DevSecOps Example con validaciones de seguridad..."
          echo " Deployment seguro exitoso!"

  security-report:
    name:  Security Report
    runs-on: ubuntu-latest
    needs: [lint, test, dependency-scan, build]
    if: always()
    steps:
      - name: Generar reporte
        run: |
          echo " === SECURITY REPORT ==="
          echo " Linting: ${{ needs.lint.result }}"
          echo " Security Tests: ${{ needs.test.result }}"
          echo " Dependency Scan: ${{ needs.dependency-scan.result }}"
          echo " Build: ${{ needs.build.result }}"
